// Generated by CoffeeScript 1.7.1
var doShare, doing, email, getKey, getPraised, praised, shareing, submiting, uname, unum;

if ( !Array.prototype.forEach ) {
    Array.prototype.forEach = function(fn, scope) {
        for(var i = 0, len = this.length; i < len; ++i) {
            fn.call(scope, this[i], i, this);
        }
    }
}

if (!Array.prototype.indexOf) {
    Array.prototype.indexOf = function (elt /*, from*/) {
        var len = this.length >>> 0;
        var from = Number(arguments[1]) || 0;
        from = (from < 0) ? Math.ceil(from) : Math.floor(from);
        if (from < 0) from += len;

        for (; from < len; from++) {
            if (from in this && this[from] === elt) return from;
        }
        return -1;
    };
}

//$.cookie('user', '{"username":"Sam樯誉","sex":"1","birthday":"0","tinyurl":"http://tp1.sinaimg.cn/1835712280/50/5634886325/1","headurl":"http://tp1.sinaimg.cn/1835712280/50/5634886325/1","mainurl":"http://tp1.sinaimg.cn/1835712280/50/5634886325/1","hometown_location":[],"work_history":[],"university_history":[],"hs_history":[],"province":"北京","city":"东城区","is_verified":"0","media_uid":"1835712280","media_type":"sinaweibo","social_uid":151259032}');
//$.cookie('4', '{"username":"Sam樯誉","sex":"1","birthday":"0","tinyurl":"http://tp1.sinaimg.cn/1835712280/50/5634886325/1","headurl":"http://tp1.sinaimg.cn/1835712280/50/5634886325/1","mainurl":"http://tp1.sinaimg.cn/1835712280/50/5634886325/1","hometown_location":[],"work_history":[],"university_history":[],"hs_history":[],"province":"北京","city":"东城区","is_verified":"0","media_uid":"1835712280","media_type":"sinaweibo","social_uid":151259032}');


function judgeStatus(){
    var user = $.cookie('user');
    if(user){
        user = $.parseJSON(user);
        $('#status').text('退出 ' + user.username);
        $('#status').click(function () {
            var indexes = ['renren','baidu','qqweibo', 'sinaweibo']
            $.removeCookie((indexes.indexOf(user.media_type)+1) + '');
            $.removeCookie('user');
            judgeStatus();
        });
        $('#status').css({
            "cursor": "pointer",
            "width": "175px",
            "text-align": "left"
        });
//        $('.goodpoint-login-ul').css('background-image', 'url("")')
        $('.li-login-renren').hide();
        $('.li-login-baidu').hide();
        $('.li-login-qq').hide();
        $('.li-login-xinlang').hide();
    }else{
        $('#status').text('登录')
        $('#status').css({
            "cursor": "default",
            "width": "51px",
            "text-align": "left"
        });
//        $('.goodpoint-login-ul').css('background-image', 'url("http://mnpublic.qiniudn.com/img/login_share.png")')
        $('.li-login-renren').show();
        $('.li-login-baidu').show();
        $('.li-login-qq').show();
        $('.li-login-xinlang').show();
    }
}

var checkLogin = function(){
    var a1, hash, token, index;
    if($.cookie('praised')){
        $('.goodpoint-foot').show();
    }

    judgeStatus();

    if (true) {
        hash = document.location.hash;
        document.location.hash = ''
        if (hash.indexOf('access_token') === -1) {
            return;
        }
        token = '';
        var indexes = ['renren','baidu','qqweibo', 'sinaweibo']
        a1 = hash.split('&');
        a1.forEach(function(h) {
            var a2 = h.split('=');
            if (a2[0] === 'access_token') {
                token = a2[1];
            }else if(a2[0] === 'media_type'){
                index = indexes.indexOf(a2[1]) +1;
            }
        });
    } else {
        token = '52.d16505b5e2bf178b5030817811c807c8.653566.1397502001.4177822361-2500182';
    }

    $.cookie('token' + index, token);
    $.get('/userinfo?access_token=' + token, function(result) {
        var user = result.results;
        $.cookie('user', user);
        $.cookie(index, user);
        judgeStatus();
        var aid = $.cookie('autoshare');
        if(aid){
            $.removeCookie('autoshare');
            doShare(aid);
        }
    });
}

checkLogin();
bindMenu();
bindLogin();
bindFootBtn();

//显示纯甄故事
function showStory(){
//        $('.mask-bg').show();
    $('#trues').modal()
//        $('.close-true-story').show();
}

//关闭纯甄故事
function hideStory(){
//        $('.mask-bg').hide();
    $('#trues').modal('hide')
//        $('.close-true-story').hide();
}


//下面3个按钮的绑定
function bindFootBtn(){
    $('.li-offline').click(function(){
        _mz_evt('1000740', '100012498');_mz_clk('1011811','4+EHn0');
        $('#offlineActivity').modal()
    });
    $('.share-img').click(function(){
        _mz_evt('1000740', '100012499');_mz_clk('1011811','4+EHo0');
        $('#praisedBox').modal()
    });
    $('.li-photo-entrance').click(function(){
        //跳转到上传甄言页面
        _mz_evt('1000740', '100012500');_mz_clk('1011811','4+EHp0');
        window.location = 'http://photo.justyoghurt.com';
    });
}

//绑定顶部导航栏
function bindMenu(){
    $('.li-good').click(function(){
//            e.preventDefault();
//            e.stopPropagation();
//            //跳转到为甄言点赞页面
        _mz_evt('1000740', '100012501');_mz_clk('1011811','4+EHq0');
        location.href = "http://like.justyoghurt.com/";
    });
    $('.li-mine').click(function(){
        //跳转到上传甄言页面
        _mz_evt('1000740', '100012502');_mz_clk('1011811','4+EHr0');
        window.location = 'http://photo.justyoghurt.com';
    });
    $('.li-detail').click(function(){
        //活动详情
        _mz_evt('1000740', '100012503');_mz_clk('1011811','4+EHs0');
        showGameDetail(0);
    });
    $('.li-rule').click(function(){
        //抽奖规则
        _mz_evt('1000740', '100012504');_mz_clk('1011811','4+EHt0');
        showGameDetail(1);
    });
    $('.li-award, .top-digit').click(function(){
        //奖品设置
        _mz_evt('1000740', '100012505');_mz_clk('1011811','4+EHu0');
        showGameDetail(2);
    });
    $('.li-story').click(function(){
        _mz_evt('1000740', '100012506');_mz_clk('1011811','4+EHv0');
        showStory();
    });
    $('#closeT').click(function(){
        //关闭纯甄故事
        hideStory();
    });

}

//绑定顶部登陆按钮
function bindLogin(){
    $('.li-login').click(function(){
        //登陆
    });
    $('.li-logout').click(function(){
        //退出
    });
    $('.li-login-renren').click(function(){
        //登陆人人
        doLogin('1');
    });
    $('.li-login-baidu').click(function(){
        //登陆百度
        doLogin('2');
    });
    $('.li-login-qq').click(function(){
        //登陆qq
        doLogin('3');
    });
    $('.li-login-xinlang').click(function(){
        //登陆微博
        doLogin('4');
    });
}

getPraised = function() {
    return $.get('/praised/get',function(result) {
        var close, html = "", i=10, initArr;
        if (result.status) {
            if(result.result)
                result = result.result.toString();
            initArr = result.split('');
            i = 10 - initArr.length;
            while (i > 0) {
                // if(i<=2)
                //     initArr.unshift("");
                // else
                    initArr.unshift("0");
                i--;
            }
            for (i; i <  initArr.length; i++) {
                html += "<li>" + initArr[i] + "</li>";
            }
            return $(".js-count").html(html+' <li class="share-link"><a href="#"><img src="img/share.jpg" class="share-img"></a></li>');
        }
    });
};

getPraised();

getKey = function(s) {
    return s.replace('/', '');
};

doing = false;

$('.pic-ruledetai').click(function() {
    _mz_evt('1000740', '100012369');
    return _mz_clk('1011811', '4+45A0');
});

$('.pic-activitydetail').click(function() {
    _mz_evt('1000740', '100012370');
    _mz_clk('1011811', '4+45B0');
});

$('#toP').click(function() {
    _mz_evt('1000740', '100012507');_mz_clk('1011811','4+EHw0');
    window.location = 'http://photo.justyoghurt.com';
});

function doLogin(t){
    var indexes = ['renren','baidu','qqweibo', 'sinaweibo']
    if ($.cookie(t)) {
        $.cookie('user', $.cookie(t));
        return showPan()
    }
    $.cookie('autoshare', t);
    _mz_evt('1000740', '100012372');
    _mz_clk('1011811', '4+45D0');
    var data = indexes[parseInt(t) - 1];
    window.location = "https://openapi.baidu.com/social/oauth/2.0/authorize?response_type=token&client_id=KktW3LP8Bhlvteqkyo6f6zCX&media_type="+data+"&redirect_uri=http%3A%2F%2Flike.justyoghurt.com%2Fcallback&client_type=web&secure=1"
}

$('#rr').click(function() {
    $('#praisedBox').modal('hide');
    if ($.cookie('1')) {
        $.cookie('user', $.cookie('1'));
        return doShare('1')
    }
    $.cookie('autoshare', 1);
    _mz_evt('1000740', '100012373');
    _mz_clk('1011811', '4+45E0');
    var data = 'renren'
    window.location = "https://openapi.baidu.com/social/oauth/2.0/authorize?response_type=token&client_id=KktW3LP8Bhlvteqkyo6f6zCX&media_type="+data+"&redirect_uri=http%3A%2F%2Flike.justyoghurt.com%2Fcallback&client_type=web&secure=1"

});

$('#bd').click(function() {
    $('#praisedBox').modal('hide');
    if ($.cookie('2')) {
        $.cookie('user', $.cookie('2'));
        return doShare('2')
    }
    $.cookie('autoshare', 2);
    _mz_evt('1000740', '100012373');
    _mz_clk('1011811', '4+45E0');
    var data = 'baidu'
    window.location = "https://openapi.baidu.com/social/oauth/2.0/authorize?response_type=token&client_id=KktW3LP8Bhlvteqkyo6f6zCX&media_type="+data+"&redirect_uri=http%3A%2F%2Flike.justyoghurt.com%2Fcallback&client_type=web&secure=1"
});

$('#qqL').click(function() {
    $('#praisedBox').modal('hide');
    if ($.cookie('3')) {
        $.cookie('user', $.cookie('3'));
        return doShare('3')
    }
    _mz_evt('1000740', '100012374');
    _mz_clk('1011811', '4+45F0');
    $.cookie('autoshare', 3);
    var data = 'qqweibo'
    window.location = "https://openapi.baidu.com/social/oauth/2.0/authorize?response_type=token&client_id=KktW3LP8Bhlvteqkyo6f6zCX&media_type="+data+"&redirect_uri=http%3A%2F%2Flike.justyoghurt.com%2Fcallback&client_type=web&secure=1"
});

$('#wb').click(function() {
    $('#praisedBox').modal('hide');
    if ($.cookie('4')) {
        $.cookie('user', $.cookie('4'));
        return doShare('4')
    }
    _mz_evt('1000740', '100012375');
    _mz_clk('1011811', '4+45G0');
    $.cookie('autoshare', 4);
    var data = 'sinaweibo'
    window.location = "https://openapi.baidu.com/social/oauth/2.0/authorize?response_type=token&client_id=KktW3LP8Bhlvteqkyo6f6zCX&media_type="+data+"&redirect_uri=http%3A%2F%2Flike.justyoghurt.com%2Fcallback&client_type=web&secure=1"
});

submiting = false;

shareing = false;

//$('#rrs').click(function() {
//    return doShare('1');
//});
//
//$('#bds').click(function() {
//    return doShare('2');
//});
//
//$('#qqs').click(function() {
//    return doShare('3');
//});
//
//$('#wbs').click(function() {
//    return doShare('4');
//});

doShare = function(b) {

    if(!$.cookie(b)){
        $.cookie('autoshare', b);
        var indexes = ['renren','baidu','qqweibo', 'sinaweibo']
        var data = indexes[b - 1];
        window.location = "https://openapi.baidu.com/social/oauth/2.0/authorize?response_type=token&client_id=KktW3LP8Bhlvteqkyo6f6zCX&media_type="+data+"&redirect_uri=http%3A%2F%2Flike.justyoghurt.com%2Fcallback&client_type=web&secure=1"
        return;
    }

    var content, email, from, pic, uname, unum, url;
    if (shareing) {
        return;
    }
    switch (b) {
        case '1':
            _mz_evt('1000740', '100012377');
            _mz_clk('1011811', '4+45I0');
            break;
        case '2':
            _mz_evt('1000740', '100012378');
            _mz_clk('1011811', '4+45J0');
            break;
        case '3':
            _mz_evt('1000740', '100012379');
            _mz_clk('1011811', '4+45K0');
            break;
        case '4':
            _mz_evt('1000740', '100012380');
            _mz_clk('1011811', '4+45L0');
    }
    shareing = true;
    from = 1;
    content = '#用味觉见证奇迹# 5月18日见证纯甄创造吉尼斯世界纪录，小伙伴们快和我一起为纯甄点赞，支持“好口味不添加”的酸牛奶，还有机会赢享百万豪礼';
    url = 'http://like.justyoghurt.com/';
    pic = 'http://share.u.qiniudn.com/amazing.jpg';
    $.post('/share', {
        content: content,
        url: url,
        pic_url: pic,
        access_token: $.cookie('token'+b),
        from: from
    }, function(result) {
        $('#logined').modal('hide');
        hidePan()
        setTimeout(function(){
            showPan()
        }, 1000)
        return shareing = false;
    });
};

praised = function() {
//    return $('#logined').modal();
};

function getUser (){
    return $.cookie('user');
}

function praise333() {
    doing = true;
    _mz_evt('1000740', '100012497');_mz_clk('1011811','4+EHm0');
    return $.post('/praised/add', function(result) {
        doing = false;
        $.cookie('praised', true);
        getPraised();
        $('#foot').show();
        setTimeout(function(){$('html, body').animate({scrollTop: $(document).height()}, 'slow')}, 500);//滚动到页面底部
        return praised();
    });
};
//显示大转盘
function showPan(){
    $('.mask-bg').show();
    $('.flash-content').show();
}

//隐藏大转盘
function hidePan(){
    $('.mask-bg').hide();
    $('.flash-content').hide();
}

function closePan(){
    hidePan()
}

//    setTimeout(showPan, 1000)
//    praise333()

//显示游戏详情面板 id 0:活动规则 1:抽奖规则 2:奖品设置
function showGameDetail(id){
//    $('#gamedetailModal').modal();
//    $('.idTabs').find('a').removeClass('selected');
//    $('.gamedetail-tab').hide();
    switch(id){
        case 0:
            $('#gamedetailModal').modal()
//            $('#tab_gamedetail').addClass('selected');
//            $('#tab-gamedetail').show();
            break;
        case 1:
            $('#gotRule').modal()
//            $('#tab_lotteryrule').addClass('selected');
//            $('#tab-lotteryrule').show();
            break;
        case 2:
            $('#lotterySetting').modal()
//            $('#tab_prize').addClass('selected');
//            $('#tab-prize').show();
            break;
        default:
            return;
    }
}

//doShare('4');

_mz_evt('1000740', '100012365');_mz_imp('1011811','4+4560');