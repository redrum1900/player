// Generated by CoffeeScript 1.7.1
(function() {
  var ModalInstanceCtrl, QRcodeCtrl, info, uploader;

  info = angular.module('InfoApp', ['ngGrid', 'ui.bootstrap', 'angularFileUpload', 'ngRoute', 'textAngular']);

  info.value('Info', {});

  info.config(function($routeProvider, $provide) {
    $routeProvider.when('/', {
      templateUrl: 'infoList.html',
      controller: 'InfoCtrl'
    }).when('/new', {
      templateUrl: 'templates/html/editor.html',
      controller: 'EditorCtrl'
    }).when('/edit', {
      templateUrl: 'templates/html/editor.html',
      controller: 'EditorCtrl'
    });
    return $provide.decorator('taOptions', [
      'taRegisterTool', '$delegate', function(taRegisterTool, taOptions) {
        taRegisterTool('im', {
          iconclass: 'fa fa-picture-o',
          action: function($deferred) {
            return this.$editor().$parent.launch('insertImage', $deferred.resolve, this.$editor().wrapSelection);
          }
        });
        taOptions.toolbar[1].push('im');
        return taOptions;
      }
    ]);
  });

  info.controller('InfoAppCtrl', function($scope, $location, Info) {
    $location.path('/');
    $scope.edit = function(data) {
      angular.extend(Info, data);
      return $location.path('/edit');
    };
    return $scope.add = function() {
      return $location.path('/new');
    };
  });

  info.controller('EditorCtrl', function($scope, $http, $timeout, Info, $upload, $modal, $location) {
    var showMsg;
    GetToken($http, function(result) {
      if (result) {
        $scope.token = result;
      }
    });
    $scope.textAreaSetup = function($element) {
      return angular.element(document).ready(function() {
        return $element.focus();
      });
    };
    $scope.Info = Info;
    showMsg = function(msg) {
      $scope.msg = msg;
      return $timeout(function() {
        return $scope.msg = '';
      }, 3000);
    };
    if (Info._id) {
      Info.htmlContent = Info.content;
    }
    $scope.preview = function() {
      var modalInstance;
      console.log('preview');
      return modalInstance = $modal.open({
        templateUrl: 'qrcode.html',
        controller: QRcodeCtrl,
        resolve: {
          url: function() {
            return imgHost + Info.url;
          }
        }
      });
    };
    $scope.cancel = function() {
      var p;
      for (p in Info) {
        delete Info[p];
      }
      return $location.path('/');
    };
    $scope.save = function(status) {
      if (!Info.title) {
        return showMsg('标题不能为空');
      }
      $scope.updating = true;
      if (!Info._id) {
        return $http.post('/info/add', {
          title: Info.title,
          content: Info.htmlContent
        }).success(function(result) {
          console.log(result);
          $scope.updating = false;
          if (result.status) {
            showMsg('保存成功');
            angular.extend(Info, result.result);
            console.log(result.result);
            if (status) {
              return $location.path('/');
            }
          } else {
            return showMsg(result.error);
          }
        });
      } else {
        return $http.post('/info/update', {
          _id: Info._id,
          title: Info.title,
          content: Info.htmlContent
        }).success(function(result) {
          console.log(result.status);
          $scope.updating = false;
          if (result.status) {
            showMsg('保存成功');
            angular.extend(Info, result.result);
            console.log(result.result);
            if (status) {
              return $location.path('/');
            }
          } else {
            return showMsg(result.error);
          }
        });
      }
    };
    return $scope.launch = function(name, finishFunction, wrapSelection) {
      var modalInstance;
      console.log(wrapSelection, finishFunction);
      modalInstance = $modal.open({
        templateUrl: 'modal.html',
        backdrop: 'static',
        controller: ModalInstanceCtrl,
        resolve: {
          upload: function() {
            return $upload;
          },
          token: function() {
            return $scope.token;
          }
        }
      });
      return modalInstance.result.then((function(data) {
        console.log(data);
        if (data) {
          wrapSelection('insertImage', imgHost + data.key, true);
          finishFunction();
        }
      }), function() {});
    };
  });

  uploader = '';

  QRcodeCtrl = function($scope, url, $timeout) {
    $scope.url = url;
    return $timeout(function() {
      return jQuery('#qrcode').qrcode(url);
    }, 500);
  };

  ModalInstanceCtrl = function($scope, $modalInstance, upload, token, $timeout) {
    $scope.data = {
      confirm: '上传'
    };
    console.log('info', $scope.data);
    $scope.buttonDisabled = true;
    $scope.ok = function() {
      console.log('ok');
      if ($scope.data.uploaded) {
        return $modalInstance.close($scope.data);
      }
    };
    $timeout(function() {
      console.log('init uploader', $('#p1'));
      return uploader = Qiniu.uploader({
        runtimes: 'html5,flash,html4',
        browse_button: 'p1',
        uptoken: token,
        unique_names: true,
        domain: imgHost,
        container: 'c1',
        max_file_size: '10mb',
        flash_swf_url: 'js/plupload/Moxie.swf',
        max_retries: 1,
        auto_start: true,
        init: {
          'FileUploaded': function(up, file, info) {
            var data;
            console.log(info, $scope.data);
            data = angular.fromJson(info);
            return $timeout(function() {
              $scope.data.key = data.key;
              $scope.data.url = imgHost + data.key + '?imageView2/1/w/100/h/100';
              $scope.data.uploaded = true;
              return $scope.buttonDisabled = false;
            }, 500);
          },
          'Error': function(up, err, errTip) {
            return console.log(up, err, errTip);
          }
        }
      });
    }, 500);
    return $scope.cancel = function() {
      $modalInstance.close();
    };
  };

  info.controller('InfoCtrl', function($scope, $http, $location) {
    $scope.search = function() {
      $scope.page = 1;
      $scope.infos = null;
      return $scope.getInfos();
    };
    $scope.getInfos = function() {
      return $http.get('/info/list', {
        params: {
          title: $scope.titleSearch,
          page: $scope.page,
          perPage: 20
        }
      }).success(function(result) {
        if (result.status) {
          if (!$scope.infos) {
            return $scope.infos = result.results;
          } else if (result.results && result.results.length) {
            return result.results.forEach(function(info) {
              return $scope.infos.push(info);
            });
          } else {
            return showAlert('没有更多的数据了');
          }
        } else {
          return showAlert(result.results);
        }
      });
    };
    $scope.getInfos();
    configScopeForNgGrid($scope);
    $scope.updateStatus = function(data) {
      $scope.updating = true;
      data.disabled = !data.disabled;
      return $http.post('/info/update/status', {
        _id: data._id,
        disabled: data.disabled
      }).success(function(result) {
        console.log(result.status);
        return $scope.updating = false;
      });
    };
    $scope.page = 1;
    $scope.$on('ngGridEventScroll', function() {
      $scope.page++;
      return $scope.getInfos();
    });
    $scope.infoGrid = {
      data: 'infos',
      multiSelect: false,
      enableRowSelection: false,
      enableSorting: false,
      columnDefs: [
        {
          field: "title",
          displayName: "标题",
          cellTemplate: textCellTemplate
        }, {
          field: "creator.username",
          width: 88,
          displayName: "创建者",
          cellTemplate: textCellTemplate
        }, {
          field: "created_at",
          width: 100,
          displayName: "创建时间",
          cellTemplate: dateCellTemplate
        }, {
          field: "updator.username",
          width: 88,
          displayName: "更新者",
          cellTemplate: textCellTemplate
        }, {
          field: "updated_at",
          width: 100,
          displayName: "更新时间",
          cellTemplate: dateCellTemplate
        }, {
          field: "handler",
          displayName: "操作",
          width: 100,
          cellTemplate: '<div class="row" ng-style="{height: rowHeight}"> <div class="col-md-8 col-md-offset-2" style="padding: 0px; display: inline-block; vertical-align: middle; margin-top: 8px"> <a class="btn btn-primary btn-xs col-md-5" ng-click="edit(row.entity)">编辑</a> <a class="btn btn-xs col-md-5 col-md-offset-2" ng-class="getButtonStyle(row.getProperty(\'disabled\'))" ng-click="updateStatus(row.entity)" ng-disabled="updating">{{ isDisabled(row.getProperty("disabled")) }}</a></div></div>'
        }
      ]
    };
  });

  angular.bootstrap(document.getElementById("infoDiv"), ['InfoApp']);

}).call(this);

//# sourceMappingURL=info.map
