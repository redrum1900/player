<?xml version="1.0" encoding="utf-8"?>
<s:Group xmlns:fx="http://ns.adobe.com/mxml/2009"
		 xmlns:s="library://ns.adobe.com/flex/spark"
		 color="0xffffff"
		 xmlns:mx="library://ns.adobe.com/flex/mx"
		 width="100%"
		 height="100%"
		 creationComplete="inited(event)"
		 xmlns:views="views.*"
		 xmlns:components="views.components.*">

	<fx:Script>
		<![CDATA[
			import com.greensock.TweenLite;
			import com.greensock.easing.Cubic;
			import com.pamakids.components.PAlert;
			import com.pamakids.components.controls.SoundPlayer;
			import com.pamakids.events.ODataEvent;
			import com.pamakids.manager.FileManager;
			import com.pamakids.manager.LoadManager;
			import com.pamakids.managers.PopupBoxManager;
			import com.pamakids.models.ResultVO;
			import com.pamakids.services.ServiceBase;
			import com.pamakids.utils.DateUtil;
			import com.pamakids.utils.URLUtil;
			import com.youli.messengers.PreloaderMessenger;
			
			import flash.net.SharedObject;
			import flash.utils.setTimeout;
			
			import mx.events.FlexEvent;
			import mx.managers.PopUpManager;
			
			import controllers.AA;
			import controllers.API;
			
			import models.InsertVO;
			import models.SongVO;

			private var player1:SoundPlayer;

//			private static const SOUND_FILE:String = "http://yuefumedia.qiniudn.com/1.mp3";

			private var player:SoundPlayer;

//			private var soundVisualizer:SoundVisualizer;

			private var volumeSO:SharedObject;

			protected function inited(event:FlexEvent):void
			{
				volumeSO=SharedObject.getLocal('yp');
				if (volumeSO.data.volume)
					vc1Volume=volumeSO.data.volume;
				if (volumeSO.data.volume2)
					vc2Volume=volumeSO.data.volume;
				//				var t:Timer = new Timer(1000);
				//				t.start();
				//				t.addEventListener(TimerEvent.TIMER, function(e:TimerEvent):void{
				//					updateTime();
				//				});
				//				updateTime();

				api=API.instance;

				initPlayer();
				panelGroup.y=info.y + info.height - 3;
				panelGroup.height=height - 57 - 48;
				panelGroup.x=2;
				panelGroup.width=width - 4;


				PreloaderMessenger.listen(PreloaderMessenger.SHOW_APP, function():void
				{
					TweenLite.delayedCall(0.5, autoLogin);
				});

				initMore();

				listPanel.addEventListener(ODataEvent.ODATA, playBroHandler);

				autoPlayTimer=new Timer(1000);
				autoPlayTimer.addEventListener(TimerEvent.TIMER, onTimer);
			}

			private var autoPlayTimer:Timer;

			private function autoLogin():void
			{
				if (api.local)
				{
					api.getMenuList();
					return;
				}
				var so:SharedObject=SharedObject.getLocal('yp');
				if (so.data.username && so.data.password)
				{
					if (api.online)
					{
						api.login(so.data.username, so.data.password, function(vo:ResultVO):void
						{
							if (vo.status)
							{
								so.data.id=ServiceBase.id;
//								so.data.broadcasts=vo.results.broadcasts;
								so.flush();
							}
							else
							{
								if (vo.errCode)
								{
									api.online=false;
									api.getMenuList();
								}
								else
								{
									var l:LoginView=new LoginView();
									PopupBoxManager.popup(l);
								}
							}
						});
					}
					else
					{
						api.getMenuList();
					}
				}
				else
				{
					if (api.online)
					{
						var l:LoginView=new LoginView();
						PopupBoxManager.popup(l);
					}
					else
					{
						PAlert.show('第一次使用需要网络连接，请联网后再试', '网络连接失败', this, function():void
						{
							autoLogin();
						}, PAlert.CONFIRM, '再试一次', '', true);
					}
				}
			}

			private function getPlayer():SoundPlayer
			{
				var p:SoundPlayer=new SoundPlayer(1000);
				p.autoPlay=true;
				return p;
			}

			private function updateTime():void
			{
				var n:Date=api.now;
				time=n.getHours() + ' : ' + n.getMinutes() + ' : ' + n.getSeconds();
			}

			[Bindable]
			private var time:String;

			private var brodcasting:Boolean;
			private var playingDM:Boolean;

			private var preMics:Array;
//			private var preVolume:Number=volume;
			private var micChanged:int;

			protected function playingHandler(event:DataEvent):void
			{
//				if (!preMics)
//				{
//					preMics=Microphone.names;
//				}
//				else if (preMics.length != Microphone.names.length)
//				{
//					preVolume=volume;
//					toVolume(0);
//					micChanged++;
//				}
//				else if (micChanged >= 2)
//				{
//					micChanged=0;
//					toVolume(preVolume);
//				}

				if (brodcasting || playingDM)
					return;
				var dms:Array=api.dmMenu ? api.dmMenu.dm_list : null;
				var pt:Number=Math.ceil(parseFloat(event.data) / 1000);
				var tt:int=Math.ceil(player.soundLength / 1000);
				time=randomPlay.selected ? '[随机播放] ' : '';
				if (song1)
					time=time + '正在播放：' + song1.name;
				else
					trace(song1);
				var value:Number=tt - pt;
				if (value < 0)
					play();
				else if (dms)
				{
					var now:Date=api.now;
					var min:Number;
					for each (var dm:InsertVO in dms)
					{
						var ns:Number=now.getTime() / 1000;
						if (dm.playTime.date != now.date)
							dm.playTime.date=now.date;
						var ds:Number=dm.playTime.getTime() / 1000;
						value=ns - ds;
						var absValue:int=Math.abs(value);
						min=min < absValue ? min : absValue;
						if (absValue <= 1)
						{
							playingDM=true;
							insertBroOrDM(dm);
							break;
						}
					}
					value=min;
					if (playingDM || (value > 0 && value < 60))
					{
						if (value > 1)
							time+=' ' + DateUtil.formateTime(value) + ' 后将插播DM';
					}
					else if (song2)
					{
						value=tt - pt;
						time+=' ' + DateUtil.formateTime(value) + ' 后将播放：' + song2.name;
					}
				}
				else if (song2)
					time+=' ' + DateUtil.formateTime(value) + ' 后将播放：' + song2.name;
				else
					time+=' ' + DateUtil.formateTime(value) + ' 后将将结束今天的播放'
			}

			protected function player1PlayedHandler(event:Event):void
			{
				play();
			}

			private var song1:SongVO;
			private var song2:SongVO;

			private var player2:SoundPlayer;
			private var playerDic:Dictionary=new Dictionary();

			private function initPlayer():void
			{
				player1=getPlayer();
				player2=getPlayer2();
				player=player1;
				player1.volume=vc1Volume / 100;
				player1.addEventListener("playing", playingHandler);
				player1.addEventListener("playComplete", player1PlayedHandler);
				API.instance.addEventListener('PLAY', function(e:Event):void
				{
					if (!player1.playing)
					{
						song1=null;
						song2=null;
					}
					play();
				});
			}

			private function getPlayer2():SoundPlayer
			{
				var p:SoundPlayer=new SoundPlayer(1000);
				p.addEventListener("playing", player2PlayingHandler);
				p.volume=vc2Volume / 100;
				p.autoPlay=true;
				return p;
			}

			private var playingIndex:int;
			private var pv:PrepareView;

			private function play():void
			{
				if (player1.playing || !api.songs || !api.songs.length)
					return;
				var now:Date=api.now;
				var has:Boolean;
				var vo:SongVO;
				var temp:Number;
				var nearestSong:SongVO;
				var firstSong:SongVO;
				if (!randomPlay.selected)
				{
					if (!song1)
					{
						if (api.isCurrentTimeLoop)
						{
							song1=api.songs[0];
							if (api.songs.length > 1)
							{
								for (var k:int=1; k < api.songs.length; k++)
								{
									song2=api.songs[k] as SongVO;
									if (song2)
										break;
								}
							}
							has=true;
						}
						else
						{
							for (var i:int; i < api.songs.length; i++)
							{
								vo=api.songs[i] as SongVO;
								if (!nearestSong)
									nearestSong=vo;
								if (!firstSong)
									firstSong=vo;
								if (vo)
								{
									if (vo.playTime.date != now.date)
										vo.playTime.date=now.date;
									var result:Number=vo.playTime.getTime() + vo.duration * 1000 - now.getTime();
									var nn:Number = nearestSong.playTime.getTime() - now.getTime();
									var vn:Number = vo.playTime.getTime() - now.getTime();
									if(now.getHours() <= 12)
										nearestSong= nn > vn ? nearestSong : vo;
									else
										nearestSong= nn < vn ? nearestSong : vo;
									if (temp)
									{
										result-=temp;
										temp=0;
									}
									if (result > 1000 && result < vo.duration * 1000)
									{
										if (vo != song1)
										{
											vo=api.songs[i];
											playingIndex=i;
											has=true;
											if (i != api.songs.length - 1)
											{
												for (i++; i < api.songs.length - 1; i++)
												{
													song2=api.songs[i] as SongVO;
													if (song2)
														break;
												}
											}
											else
												song2=null
											song1=vo;
											break;
										}
										else
										{
											temp=result;
										}
									}
								}
							}
						}
					}
					else
					{
						has=true;
						if (song2)
						{
							song1=song2;
							var index:int=api.songs.indexOf(song2);
							if (index == -1)
							{
								song1=null;
								song2=null;
								play();
								return;
							}
							if (index != api.songs.length - 1)
							{
								for (index++; i < api.songs.length - 1; index++)
								{
									song2=api.songs[index] as SongVO;
									if (song2)
										break;
								}
							}
							else if (api.isCurrentTimeLoop)
							{
								song2=api.songs[0];
							}
							else
							{
								song2=null;
							}
						}
						else if (api.isCurrentTimeLoop)
						{
							song1=api.songs[0];
							if (api.songs.length > 1)
								song2=api.songs[1] as SongVO;
						}
						else
						{
							song1=null;
							has=false;
						}
					}
				}
				else
				{
					var svo:SongVO=api.getRandomSong();
					while (song1._id == svo._id)
					{
						svo=api.getRandomSong();
					}
					song1=svo
					if (song1)
						has=true;
					else
					{
						PAlert.show('抱歉，当前时段没有可随机播放的曲目，请取消随机播放或联系我们');
						randomPlay.selected=false;
						play();
						return;
					}
				}
				if (!has)
				{
					if (player1.playing)
						player1.stop();
					if (!autoPlayTimer.running)
						autoPlayTimer.start();
					song1=null;
					api.playingSong=null;
					if (nearestSong)
					{
						var value:Number=(nearestSong.playTime.getTime() - now.getTime()) / 1000;
						if (value < 0)
						{
							firstSong.playTime.date++;
							value=(firstSong.playTime.getTime() - now.getTime()) / 1000;
						}
						time='当前时段无媒资可播放 ' + DateUtil.formateTime(value) + ' 后将播放 ' + nearestSong.name;
					}
					else
					{
						TweenLite.killDelayedCallsTo(play);
						TweenLite.delayedCall(3, play);
					}
				}
				else
				{
					if (autoPlayTimer.running)
						autoPlayTimer.stop();
					vo=song1;
					api.playingSong=vo;
					api.playingIndex=api.songs.indexOf(song1);
					listPanel.to(api.playingIndex);
					AA.say('play');
					time='准备开始播放 ' + vo.name;
					var path:String=FileManager.savedDir + URLUtil.getCachePath(vo.url);
					trace(path);
					var f:File=new File(path);
					now=api.now;
					var s:Number=now.getTime() - vo.playTime.getTime();
					trace(DateUtil.getHMS(vo.playTime), s, DateUtil.getHMS(now));
					if (f.exists)
					{
						player.url=new File(FileManager.savedDir + URLUtil.getCachePath(vo.url)).url;
						if (!api.isCurrentTimeLoop)
							player.currentPosition=s;
					}
					else
					{
						LoadManager.instance.load(vo.url, function():void
						{
							player.url=new File(FileManager.savedDir + URLUtil.getCachePath(vo.url)).url;
							if (!api.isCurrentTimeLoop)
								player.currentPosition=s;
						}, URLUtil.getCachePath(vo.url), null, function(percent:Number):void
						{
							if (!player1.playing)
								time='第一次播放 ' + vo.name + ' ，请稍候，加载进度 ' + Math.round(percent * 100) + '%';
						});
					}
//					setTimeout(function():void{
//						soundVisualizer.setCover(vo.cover);
//					}, 1000);
				}
			}

			protected function randomPlay_changeHandler(event:Event):void
			{
//				trace(randomPlay.selected);
				if (!song1)
					play();
			}

//			protected function songList_changeHandler(event:Event):void
//			{
//				var wait:Number = 0;
//				if(panel && panel != songPanel){
//					hide(panel);
//					wait = 0.5;
//				}
//				TweenLite.delayedCall(wait, function():void{
//					if(!songPanel){
//						songPanel = new ListPanel();
//						songPanel.width = panelGroup.width;
//						songPanel.height = panelGroup.height;
//						panelGroup.addElement(songPanel);
//						panelButton[songPanel] = songList;
//					}
//
//					songList.selected ? show(songPanel) : hide(songPanel);
//				});
//			}

//			private var panel:Group;
//			private var broPanel:BroPanel;
//			private var panelButton:Dictionary = new Dictionary();
//
//			protected function broList_changeHandler(event:Event):void
//			{
//				var wait:Number = 0;
//				if(panel && panel != broPanel){
//					hide(panel);
//					wait = 0.5;
//				}
//				TweenLite.delayedCall(wait, function():void{
//					if(!broPanel)
//					{
//						broPanel = new BroPanel();
//						broPanel.width = panelGroup.width;
//						broPanel.height = panelGroup.height;
//						broPanel.addEventListener(ODataEvent.ODATA, playBroHandler);
//						panelGroup.addElement(broPanel);
//						panelButton[broPanel] = broList;
//					}
//
//					broList.selected ? show(broPanel) : hide(broPanel);
//				});
//			}

			private function show(p:Group):void
			{
				p.x=panelGroup.width;
				TweenLite.to(p, 0.5, {x: 0, ease: Cubic.easeOut});
//				soundVisualizer.graphics.clear()
//				panel=p;
			}

			private function hide(p:Group):void
			{
//				panelButton[p].selected=false;
				TweenLite.to(p, 0.5, {x: panelGroup.width, ease: Cubic.easeOut});
//				panel=null;
			}

			private var menuListPanel:MenuListPanel;
			private var api:API;

			protected function insertSong_changeHandler(event:Event):void
			{
				var wait:Number=0;
//				if(panel && panel != insertPanel){
//					hide(panel);
//					wait = 0.5;
//				}
//				TweenLite.delayedCall(wait, function():void{
//					if(!insertPanel)
//					{
//						insertPanel = new InsertPanel();
//						insertPanel.width = panelGroup.width;
//						insertPanel.height = panelGroup.height;
//						insertPanel.addEventListener(ODataEvent.ODATA, playBroHandler);
//						panelGroup.addElement(insertPanel);
//						panelButton[insertPanel] = insertSong;
//					}
//
//					insertSong.selected ? show(insertPanel) : hide(insertPanel);
//				});
			}

			protected function playBroHandler(event:ODataEvent):void
			{
				if (brodcasting)
					return;
				PAlert.show('请问是否确认播放 ' + event.data.name, '提示', null, function(value:String):void
				{
					if (value == PAlert.YES)
					{
						brodcasting=true;
						var vo:InsertVO=event.data as InsertVO;
						insertBroOrDM(vo, true);
					}
				}, PAlert.YESNO);
			}

			protected function more_clickHandler(event:MouseEvent):void
			{
				moreMenu.display(this.stage, event.stageX, event.stageY);
			}

			private var moreMenu:NativeMenu
			private const CLOSE:String='CLOSE';
			private const CONTACT_US:String='CONTACT_US';
			private const ABOUT_US:String='ABOUT_US';
			private const CLEAR_CACHE:String='CLEAR_CACHE';
			private const FEEDBACK:String='FEEDBACK';
			private const REMOTE_ACCOUNT:String='REMOTE_ACCOUNT';

			private function initMore():void
			{
				moreMenu=new NativeMenu();
				moreMenu.addItem(getNMI('联系我们', CONTACT_US));
//				moreMenu.addItem(getNMI('意见反馈', FEEDBACK));
				if (api.isTest)
				{
					moreMenu.addItem(getNMI('清空缓存文件', CLEAR_CACHE));
					moreMenu.addItem(getNMI('注销账户并退出', REMOTE_ACCOUNT));
				}
//				moreMenu.addItem(getNMI('','', true));
//				moreMenu.addItem(getNMI('关于我们', ABOUT_US));
//				moreMenu.addItem(getNMI('关闭程序', CLOSE));
			}

			private function getNMI(label:String, data:Object, isSeparator:Boolean=false):NativeMenuItem
			{
				var i:NativeMenuItem=new NativeMenuItem(label, isSeparator);
				i.data=data
				i.addEventListener(Event.SELECT, selectedHandler);
				return i;
			}

			protected function selectedHandler(event:Event):void
			{
				trace(event.target.data);
				switch (event.target.data)
				{
					case CLOSE:
						NativeApplication.nativeApplication.exit();
						break;
					case FEEDBACK:
					case CONTACT_US:
					case ABOUT_US:
						PAlert.show('客服电话1:51244052\n客服电话2:58699501\nqq1：王萍99651674\nqq2：杨丹丹674357918\nqq3：段颖3779317');
//						navigateToURL(new URLRequest('http://weibo.com/u/2662098313'));
						break;
					case CLEAR_CACHE:
						PAlert.show('您确认清空缓存文件吗？', '提示', null, function(value:String):void
						{
							if (value == PAlert.YES)
							{
								var f:File=new File(FileManager.savedDir)
								if (f.exists)
								{
									f.deleteDirectoryAsync(true);
									f.addEventListener(Event.COMPLETE, function(e:Event):void
									{
										PAlert.show('您的缓存已清空，请放心使用');
									})
								}
							}
						}, PAlert.YESNO);
						break;
					case REMOTE_ACCOUNT:
						PAlert.show('您确认注销账户并退出吗？退出后再次使用需要重新登录', '提示', null, function(value:String):void
						{
							if (value == PAlert.YES)
							{
								var so:SharedObject=SharedObject.getLocal('yp');
								so.clear();
								so.flush();
								NativeApplication.nativeApplication.exit();
							}
						}, PAlert.YESNO);
						break;
				}
			}

			protected function button1_clickHandler(event:MouseEvent):void
			{
				PAlert.show('退出后将停止公播', '退出播放', null, function(value:String):void
				{
					if (value == PAlert.YES)
						NativeApplication.nativeApplication.exit();
				}, PAlert.YESNO);
			}

			protected function button2_clickHandler(event:MouseEvent):void
			{
				NativeApplication.nativeApplication.activeWindow.minimize()
			}

			private var updating:Boolean;

			protected function button3_clickHandler(event:MouseEvent):void
			{
				if (this.updating)
					return;
				updateButton.label='下载更新';
				updating=true;
				api.updater.addEventListener(ProgressEvent.PROGRESS, function(e:ProgressEvent):void
				{
					var percent:Number=e.bytesLoaded / e.bytesTotal;
					percent=Math.round(percent * 100);
					updateButton.label='更新进度' + percent + '%';
				});
				api.updater.downloadUpdate();
			}

			private var dmPlayers:Dictionary=new Dictionary();
			private var broDic:Dictionary=new Dictionary();

			private function insertBroOrDM(data:InsertVO, isBro:Boolean=false):void
			{
				var ivo:InsertVO=data;
				var naiveURL:String=FileManager.savedDir + URLUtil.getCachePath(ivo.url);
				var url:String=data.url.indexOf('recorded') == -1 ? new File(naiveURL).url : new File(FileManager.savedDir + data.url).url;
				broDic[url]=ivo;
				time=data.playTime && data.playTime.valueOf() ? '开始插播DM：' : '开始广播：';
				time+=ivo.name;
				if (ivo.repeat)
				{
					time+=' ' + ivo.repeat + ' 次';
				}
				else
				{
					time+='';
				}
				if (ivo.interval)
				{
					time+=' 每次间隔 ' + ivo.repeat + ' 秒';
				}
				player1.muted=true;
				setTimeout(function():void
				{
					player2Time=time;
					var sp:SoundPlayer;
					if (isBro)
					{
						playBro(ivo);
					}
					else
					{
						sp=dmPlayers[url] as SoundPlayer;
						if (!sp)
						{
							sp=getPlayer2();
							dmPlayers[url]=sp;
							if (ivo.repeat)
							{
								sp.repeat=true;
								sp.repeatTimes=ivo.repeat;
								sp.repeatInterval=ivo.interval;
								sp.addEventListener("playRepeatComplete", function(e:Event):void
								{
									dmPlayed(ivo);
								});
							}
							else
							{
								sp.repeat=false;
								sp.addEventListener("playComplete", function(e:Event):void
								{
									dmPlayed(ivo);
								});
							}
							sp.volume=vc2Volume / 100;
							sp.url=url;
						}
						else
						{
							if (sp.muted)
								sp.muted=false;
						}
					}
				}, 800)
			}

			protected function onTimer(event:TimerEvent):void
			{
				if (!song1)
					play();
			}

			protected function bro_clickHandler(event:MouseEvent):void
			{
				var av:AddBroView=new AddBroView();
				PopupBoxManager.popup(av, function():void
				{
					api.initBroadcasts();
				});
			}

			private var player2Time:String;

			protected function player2PlayingHandler(event:DataEvent):void
			{
				var sp:SoundPlayer=event.target as SoundPlayer;
				if (player2.playing && sp != player2)
					return;
				var pt:Number=Math.ceil(parseFloat(event.data) / 1000);
				var tt:int=Math.ceil(sp.soundLength / 1000);
				time=player2Time + ' ' + DateUtil.formateTime(tt - pt) + ' 后结束'
			}

			protected function menuList_changeHandler(event:Event):void
			{
				if (!menuListPanel)
				{
					menuListPanel=new MenuListPanel();
					menuListPanel.width=panelGroup.width;
					menuListPanel.height=panelGroup.height;
					menuListPanel.addEventListener(ODataEvent.ODATA, playBroHandler);
					panelGroup.addElement(menuListPanel);
				}
				if (menuList.selected)
					show(menuListPanel);
				else
					hide(menuListPanel);
			}
			
			private var vc1Volume:Number=50;
			private var vc2Volume:Number=50;

			protected function vc1_changingHandler(event:ODataEvent):void
			{
				vc1Volume=event.data as Number;
				if (brodcasting || playingDM)
					return
				else
					player.volume=vc1Volume / 100;
				volumeSO.data.volume=vc1Volume;
				volumeSO.flush();
			}

			protected function vc2_changingHandler(event:ODataEvent):void
			{
				vc2Volume=event.data as Number;
				if (brodcasting)
					player2.volume=vc2Volume / 100;
				else if (playingDM)
				{
					for each (var sp:SoundPlayer in dmPlayers)
					{
						if (sp.playing)
							sp.volume=vc2Volume / 100;
					}
				}
				volumeSO.data.volume2=vc2Volume;
				volumeSO.flush();
			}
			
			protected function listPanel_startRecordHandler(event:Event):void
			{
				var volume:Number = 0;
				player.volume=volume / 100;
				if (brodcasting)
					player2.volume=volume / 100;
				else if (playingDM)
				{
					for each (var sp:SoundPlayer in dmPlayers)
					{
						if (sp.playing)
							sp.volume=volume / 100;
					}
				}
			}
			
			protected function listPanel_stopRecordHandler(event:Event):void
			{
				player.volume=vc1Volume / 100;
				if (brodcasting)
					player2.volume=vc2Volume / 100;
				else if (playingDM)
				{
					for each (var sp:SoundPlayer in dmPlayers)
					{
						if (sp.playing)
							sp.volume=vc2Volume / 100;
					}
				}
			}
			
			private var broAlert:PAlert;
			
			private function dmPlayed(ivo:InsertVO):void
			{
				var naiveURL:String=FileManager.savedDir + URLUtil.getCachePath(ivo.url);
				var url:String=ivo.url.indexOf('recorded') == -1 ? new File(naiveURL).url : new File(FileManager.savedDir + ivo.url).url;
				if (!brodcasting)
				{
					player1.muted=false;
					brodcasting=false;
					playingDM=false;
				}
				delete dmPlayers[url];
				delete broDic[url];
			}
			
			private function broPlayed():void
			{
				var hasDMPlaying:Boolean;
				for each (var sp:SoundPlayer in dmPlayers)
				{
					if (sp.playing)
					{
						player2Time='开始插播DM：' + broDic[sp.url].name;
						sp.muted=false;
						hasDMPlaying=true;
						break;
					}
				}
				if (!hasDMPlaying)
				{
					player1.muted=false;
					playingDM=false;
				}
				brodcasting=false;
			}
			
			private function playBro(ivo:InsertVO):void
			{
				var naiveURL:String=FileManager.savedDir + URLUtil.getCachePath(ivo.url);
				var url:String=ivo.url.indexOf('recorded') == -1 ? new File(naiveURL).url : new File(FileManager.savedDir + ivo.url).url;
				var sp:SoundPlayer;
				for each (sp in dmPlayers)
				{
					sp.muted=true;
				}
				if (ivo.repeat)
				{
					player2.repeat=true;
					player2.repeatTimes=ivo.repeat;
					player2.repeatInterval=ivo.interval;
					player2.addEventListener("playRepeatComplete", function(e:Event):void
					{
						if(broAlert){
							PopUpManager.removePopUp(broAlert);
							broAlert=null;
						}
						broPlayed();
					});
				}
				else
				{
					player2.repeat=false;
					player2.addEventListener("playComplete", function(e:Event):void
					{
						if(broAlert){
							PopUpManager.removePopUp(broAlert);
							broAlert=null;
						}
						broPlayed();
					});
				}
				setTimeout(function():void
				{
					player2.volume=vc2Volume / 100;
					player2.url=url;
					broAlert = PAlert.show('播放广播:'+ivo.name+'中，如果要临时停止请点击【确认】', '提示', null, function():void{ivo
						player2.stop();
						broPlayed();
						broAlert = null;
					}, PAlert.CONFIRM);
				}, 800);
			}
			
		]]>
	</fx:Script>

	<mx:UIComponent id="sv"
					mouseChildren="false"
					y="{info.y}"
					mouseEnabled="false"/>
	<s:BitmapImage id="background"
				   source="@Embed('/assets/panelBG.jpg')"
				   width="100%"
				   height="100%"
				   fillMode="repeat"/>
	<s:Group id="panelGroup"
			 clipAndEnableScrolling="true">
		<views:ListPanel id="listPanel"
						 startRecord="listPanel_startRecordHandler(event)"
						 stopRecord="listPanel_stopRecordHandler(event)"
						 width="100%"
						 height="100%"/>
	</s:Group>

	<s:Group height="57"
			 width="100%">
		<s:Group id="info"
				 y="{topBG.height}"
				 width="100%">
			<s:BitmapImage x="1"
						   source="@Embed('/assets/trasBG.png')"/>
			<s:Label text="{time}"
					 color="0xd9dee3"
					 fontSize="14"
					 left="20"
					 width="615"
					 verticalCenter="0"/>
			<s:HGroup right="20"
					  verticalCenter="0"
					  verticalAlign="middle">
				<s:ToggleButton skinClass="skins.ListButton"
								buttonMode="true"
								change="menuList_changeHandler(event)"
								id="menuList"
								toolTip="{menuList.selected ? '关闭列表' : '打开列表'}"/>
				<!--
<s:ToggleButton skinClass="skins.BroButton"
				buttonMode="true"
				id="broList"
				change="broList_changeHandler(event)"
				toolTip="{broList.selected ? '关闭广播' : '手动广播'}"
				/>
<s:ToggleButton skinClass="skins.InsertButton"
				buttonMode="true"
				change="insertSong_changeHandler(event)"
				id="insertSong"
				toolTip="{insertSong.selected ? '关闭定时插播' : '定时插播'}"
				/>
		  />-->
				<s:ToggleButton id="randomPlay"
								change="randomPlay_changeHandler(event)"
								mouseDown="event.stopImmediatePropagation()"
								buttonMode="true"
								skinClass="skins.RandomButton"
								toolTip="{randomPlay.selected ? '取消随机播放' : '开启随机播放'}"/>
				<s:Button id="more"
						  mouseDown="event.stopImmediatePropagation()"
						  buttonMode="true"
						  skinClass="skins.MoreButtonSkin"
						  toolTip="更多"
						  click="more_clickHandler(event)"/>
			</s:HGroup>
		</s:Group>
		<s:BitmapImage horizontalCenter="0"
					   source="@Embed('/assets/topBG.png')"
					   id="topBG">
			<s:filters>
				<s:DropShadowFilter angle="90"
									blurX="3"
									blurY="3"
									alpha=".1"/>
			</s:filters>
		</s:BitmapImage>
		<s:HGroup width="100%"
				  height="100%"
				  verticalAlign="middle"
				  paddingLeft="20"
				  paddingRight="20">
			<components:Logo/>
			<!--<s:Label text="乐府时代播放器" fontSize="22" color="0xffffff" left="20" verticalCenter="0"/>-->
			<components:VolumeController id="vc1"
										 changing="vc1_changingHandler(event)"
										 label="背景音调节"/>
			<components:VolumeController id="vc2"
										 changing="vc2_changingHandler(event)"
										 label="其它音调节"/>
			<s:Spacer width="100%"/>
			<s:Button fontSize="14"
					  id="updateButton"
					  color="0x191C1E"
					  skinClass="skins.buttons.DefaultButtonSkin"
					  visible="{API.instance.updatable}"
					  click="button3_clickHandler(event)"
					  label="更新"/>
			<s:Button fontSize="14"
					  color="0x191C1E"
					  skinClass="skins.buttons.PrimaryButtonSkin"
					  id="bro"
					  includeInLayout="{API.instance.local}"
					  visible="{API.instance.local}"
					  click="bro_clickHandler(event)"
					  label="广播"/>
			<s:Button fontSize="14"
					  color="0x191C1E"
					  skinClass="skins.buttons.DefaultButtonSkin"
					  click="button2_clickHandler(event)"
					  label="缩小"/>
			<s:Button fontSize="14"
					  skinClass="skins.buttons.WarningButtonSkin"
					  click="button1_clickHandler(event)"
					  label="退出"/>
		</s:HGroup>
	</s:Group>



</s:Group>
